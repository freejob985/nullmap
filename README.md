# نظام إدارة المواقع الجغرافية (NullMap)

نظام ويب متكامل لإدارة المواقع الجغرافية، يتيح للمستخدمين إضافة وتعديل وحذف الدول والأماكن، مع عرضها على خريطة تفاعلية.

## المميزات

- واجهة مستخدم عربية بالكامل مع دعم RTL
- خريطة تفاعلية باستخدام Leaflet.js
- نظام إدارة مستخدمين متكامل مع صلاحيات
- جداول تفاعلية مع إمكانية البحث والترتيب
- تصفية المواقع حسب الدولة والنوع
- تجميع المواقع المتقاربة على الخريطة
- تصميم متجاوب مع جميع الأجهزة

## المتطلبات

- PHP 7.4 أو أحدث
- MySQL 5.7 أو أحدث
- خادم ويب (Apache/Nginx)
- متصفح حديث يدعم JavaScript

## التثبيت

1. قم بنسخ الملفات إلى مجلد الخادم
2. قم بإنشاء قاعدة بيانات جديدة
3. قم بتعديل ملف `config/database.php` بمعلومات قاعدة البيانات
4. قم بتنفيذ ملف `database/schema.sql` لإنشاء الجداول
5. قم بتسجيل الدخول باستخدام:
   - البريد: admin@nullmap.local
   - كلمة المرور: admin123

## هيكل المشروع

```
nullmap/
├── api/                    # نقاط نهاية API
│   ├── countries.php      # إدارة الدول
│   ├── places.php         # إدارة الأماكن
│   └── users.php          # إدارة المستخدمين
├── assets/                # الملفات الثابتة
│   ├── css/              # ملفات CSS
│   └── js/               # ملفات JavaScript
├── config/                # ملفات الإعداد
│   └── database.php      # إعدادات قاعدة البيانات
├── database/             # ملفات قاعدة البيانات
│   └── schema.sql        # هيكل قاعدة البيانات
├── helpers/              # الدوال المساعدة
│   ├── auth.php          # المصادقة والتفويض
│   ├── database.php      # اتصال قاعدة البيانات
│   └── validation.php    # التحقق من الصحة
├── includes/             # الملفات المشتركة
│   └── navbar.php        # شريط التنقل
├── index.php             # الصفحة الرئيسية
├── login.php             # صفحة تسجيل الدخول
├── map.php               # صفحة الخريطة
├── countries.php         # صفحة الدول
├── places.php            # صفحة الأماكن
└── users.php             # صفحة المستخدمين
```

## الوظائف الرئيسية

### المصادقة (`helpers/auth.php`)
- `login($email, $password)`: تسجيل الدخول
- `logout()`: تسجيل الخروج
- `isLoggedIn()`: التحقق من تسجيل الدخول
- `requireLogin()`: طلب تسجيل الدخول
- `isAdmin()`: التحقق من صلاحيات المدير
- `requireAdmin()`: طلب صلاحيات المدير

### قاعدة البيانات (`helpers/database.php`)
- `getInstance()`: الحصول على نسخة وحيدة
- `getConnection()`: الحصول على اتصال PDO
- `query($sql, $params)`: تنفيذ استعلام
- `fetchOne($sql, $params)`: جلب صف واحد
- `fetchAll($sql, $params)`: جلب جميع الصفوف

### التحقق من الصحة (`helpers/validation.php`)
- `validate($data, $rules)`: التحقق من البيانات
- `sanitize($data)`: تنظيف البيانات
- `getErrors()`: الحصول على الأخطاء

## API Endpoints

### الدول (`api/countries.php`)
- `GET /api/countries.php`: قائمة الدول
- `GET /api/countries.php?id=X`: تفاصيل دولة
- `POST /api/countries.php`: إضافة دولة
- `PUT /api/countries.php?id=X`: تعديل دولة
- `DELETE /api/countries.php?id=X`: حذف دولة

### الأماكن (`api/places.php`)
- `GET /api/places.php`: قائمة الأماكن
- `GET /api/places.php?id=X`: تفاصيل مكان
- `POST /api/places.php`: إضافة مكان
- `PUT /api/places.php?id=X`: تعديل مكان
- `DELETE /api/places.php?id=X`: حذف مكان

### المستخدمون (`api/users.php`)
- `GET /api/users.php`: قائمة المستخدمين
- `GET /api/users.php?id=X`: تفاصيل مستخدم
- `POST /api/users.php`: إضافة مستخدم
- `PUT /api/users.php?id=X`: تعديل مستخدم
- `DELETE /api/users.php?id=X`: حذف مستخدم

## التغييرات الأخيرة

### التعديلات الجديدة (تاريخ التحديث: 2023-12-15)

1. إضافة تصدير البيانات إلى Excel:
   - تم إضافة زر تصدير إلى Excel في صفحة الأماكن (places.php)
   - تم إضافة دعم لترجمة أسماء الأعمدة إلى اللغة العربية عند التصدير
   - تم إضافة ترجمة لقيم حقل النوع (خاص/حكومي) في ملف التصدير
   - تم إضافة API خاص بالتصدير (api/export.php) مع التحقق من الصلاحيات

2. إضافة نظام صلاحيات متكامل للمستخدمين:
   - تم إنشاء جداول الصلاحيات في قاعدة البيانات (permissions_schema.sql)
   - تم تحديث نظام المصادقة لدعم الصلاحيات المتعددة (helpers/auth.php)
   - تم إضافة صفحة لإدارة صلاحيات المستخدمين (user_permissions.php)
   - تم تحديث واجهات API للتحقق من صلاحيات المستخدم (api/places.php, api/users.php)
   - تم إضافة صلاحيات محددة: عرض، إضافة، تعديل، حذف، تصدير للأماكن والدول والمستخدمين
   - تم إضافة صلاحية خاصة لإدارة صلاحيات المستخدمين

### التعديلات الجديدة (تاريخ التحديث: 2023-11-30)

1. إضافة تصفية حسب الأماكن في صفحة الخريطة:
   - تم إضافة قائمة منسدلة جديدة للأماكن في صفحة الخريطة (الأسطر 150-155)
   - تم إضافة دالة `loadPlaceOptions` لتحميل خيارات الأماكن بناءً على الدولة والمدينة المختارة (الأسطر 230-255)
   - تم تعديل دالة `loadPlaces` لتطبيق التصفية حسب المكان المحدد (الأسطر 328-330)
   - تم إضافة معالجات أحداث لتحديث قائمة الأماكن عند تغيير الدولة أو المدينة (الأسطر 379-390)
   ```javascript
   /**
    * تحميل الأماكن المتاحة بناءً على الدولة والمدينة المختارة
    * @param {number} countryId - معرف الدولة المختارة
    * @param {string} cityName - اسم المدينة المختارة
    */
   function loadPlaceOptions(countryId, cityName) {
       // تفريغ قائمة الأماكن
       $('#placeFilter').empty().append('<option value="">الكل</option>');
       
       // تصفية الأماكن حسب الدولة والمدينة
       let filteredPlaces = places;
       
       if (countryId) {
           filteredPlaces = filteredPlaces.filter(place => place.country_id == countryId);
       }
       
       if (cityName) {
           filteredPlaces = filteredPlaces.filter(place => place.city === cityName);
       }
       
       // تحميل الأماكن الفريدة
       const uniquePlaces = filteredPlaces.map(place => ({
           id: place.id,
           name: place.name
       }));
       
       // ترتيب الأماكن أبجدياً
       uniquePlaces.sort((a, b) => a.name.localeCompare(b.name));
       
       // إضافة الأماكن إلى القائمة المنسدلة
       uniquePlaces.forEach(place => {
           $('#placeFilter').append(`<option value="${place.id}">${place.name}</option>`);
       });
   }
   ```

### التعديلات الجديدة (تاريخ التحديث: 2023-11-25)

1. إصلاح مشكلة عدم إضافة نوع المكان (حكومي أو خاص):
   - المشكلة: عند إضافة مكان جديد، لم يكن يتم حفظ نوع المكان (حكومي أو خاص) في قاعدة البيانات بشكل صحيح
   - السبب: عدم تطابق بين قيم النوع المستخدمة في واجهة المستخدم ("خاص" و"حكومة") وقيم النوع المتوقعة في API ("private" و"government")
   - الحل: تم تعديل نماذج إضافة وتعديل المكان في ملف places.php (الأسطر 116-119 و 177-180) لاستخدام القيم الإنجليزية كقيم للنموذج مع الاحتفاظ بالنص العربي للعرض
   ```html
   <!-- نموذج إضافة المكان -->
   <div class="mb-3">
       <label for="type" class="form-label">النوع</label>
       <select class="form-select" id="type" name="type" required>
           <option value="">اختر النوع</option>
           <option value="private">خاص</option>
           <option value="government">حكومة</option>
       </select>
   </div>
   
   <!-- نموذج تعديل المكان -->
   <div class="mb-3">
       <label for="editType" class="form-label">النوع</label>
       <select class="form-select" id="editType" name="type" required>
           <option value="">اختر النوع</option>
           <option value="private">خاص</option>
           <option value="government">حكومة</option>
       </select>
   </div>
   ```

### التعديلات الجديدة (تاريخ التحديث: 2023-11-20)

1. تحسينات صفحة الخريطة (map.php):
   - إضافة تصفية حسب المدينة: تم إضافة خيار تصفية الأماكن حسب المدينة مع تحميل المدن ديناميكياً بناءً على الدولة المختارة (الأسطر 120-135)
   - تحسين عرض العلامات على الخريطة: تم إضافة أيقونات مميزة وتكبير حجم العلامات وإضافة تأثيرات تفاعلية (الأسطر 250-280)
   - إضافة أيقونات مميزة: تم استخدام أيقونة `mdi-home` للأماكن الخاصة وأيقونة `mdi-office-building` للأماكن الحكومية (الأسطر 260-275)
   - تكبير حجم العلامات: تم زيادة حجم العلامات على الخريطة لتكون أكثر وضوحاً (الأسطر 270-275)
   - إضافة تأثيرات تفاعلية: تم إضافة تأثير تكبير عند تمرير المؤشر فوق العلامة (الأسطر 80-95)
   - تحسين تنظيم الكود: تم إعادة تنظيم الكود وفصل المنطق إلى دوال مستقلة ذات مسؤوليات محددة (الأسطر 200-350)
   - إضافة توثيق: تم إضافة تعليقات توثيقية لشرح وظيفة كل دالة ومعاملاتها ومخرجاتها (جميع أنحاء الملف)

### التعديلات الجديدة (تاريخ التحديث: 2023-11-16)

1. تحديث تلقائي للإحداثيات عند اختيار الدولة في صفحة الدول:
   - تم إضافة قاموس للإحداثيات الافتراضية للدول المحددة في `countries.php` (الأسطر 236-247)
   ```javascript
   const countryCoordinates = {
       'مصر': { lat: 30.0444, lng: 31.2357 },
       'ماليزيا': { lat: 3.1390, lng: 101.6869 },
       'قطر': { lat: 25.2854, lng: 51.5310 },
       'جورجيا': { lat: 41.7151, lng: 44.8271 },
       'قبرص': { lat: 35.1856, lng: 33.3823 },
       'المانيا': { lat: 52.5200, lng: 13.4050 },
       'هولندا': { lat: 52.3676, lng: 4.9041 },
       'بريطانيا': { lat: 51.5074, lng: -0.1278 },
       'ج افريقيا': { lat: -33.9249, lng: 18.4241 }
   };
   ```
   - تم إضافة معالجات أحداث لتحديث الإحداثيات تلقائيًا عند اختيار الدولة في نموذجي الإضافة والتعديل (الأسطر 290-305)
   - تم إضافة أزرار لإعادة تعيين الإحداثيات إلى موقع الدولة الافتراضي (الأسطر 116-118 و 170-172)
   - تم إضافة دالة مساعدة `updateCoordinatesByCountry` لتوحيد عملية تحديث الإحداثيات (الأسطر 290-310)
   ```javascript
   function updateCoordinatesByCountry(formPrefix, countryName) {
       if (countryCoordinates[countryName]) {
           const coords = countryCoordinates[countryName];
           $(`#${formPrefix}Latitude`).val(coords.lat);
           $(`#${formPrefix}Longitude`).val(coords.lng);
           
           // تحديث الخريطة
           if (formPrefix === 'add') {
               addMarker.setLatLng([coords.lat, coords.lng]);
               addMap.setView([coords.lat, coords.lng], 10);
           } else if (formPrefix === 'edit') {
               editMarker.setLatLng([coords.lat, coords.lng]);
               editMap.setView([coords.lat, coords.lng], 10);
           }
       }
   }
   ```

2. تحويل حقل اسم الدولة إلى قائمة منسدلة بدول محددة:
   - تم تعديل `modals/countries.php` (الأسطر 39-54) لتغيير حقل إدخال اسم الدولة من حقل نصي إلى قائمة منسدلة
   - تم تعديل `countries.php` (الأسطر 88-103) لتغيير حقل إدخال اسم الدولة في نموذج الإضافة
   - تم تعديل `countries.php` (الأسطر 137-152) لتغيير حقل إدخال اسم الدولة في نموذج التعديل
   - تم إضافة الدول المحددة: مصر، ماليزيا، قطر، جورجيا، قبرص، المانيا، هولندا، بريطانيا، ج افريقيا

3. تحسين تجربة المستخدم عند تحديد الإحداثيات:
   - تم إضافة أزرار "إعادة تعيين الإحداثيات" في نماذج الإضافة والتعديل
   - تم إضافة معالجات أحداث لأزرار إعادة التعيين لاستعادة الإحداثيات الافتراضية للدولة المحددة
   ```javascript
   // معالج حدث زر إعادة تعيين الإحداثيات في نموذج الإضافة
   $('#resetAddCoordinates').on('click', function() {
       const countryName = $('#addCountryName').val();
       updateCoordinatesByCountry('add', countryName);
   });
   
   // معالج حدث زر إعادة تعيين الإحداثيات في نموذج التعديل
   $('#resetEditCoordinates').on('click', function() {
       const countryName = $('#editCountryName').val();
       updateCoordinatesByCountry('edit', countryName);
   });
   ```

4. تحسين ربط الدول والمدن والإحداثيات في صفحة الأماكن:
   - تم التحقق من وظيفة تحديث المدينة وخطوط الطول والعرض تلقائيًا عند اختيار الدولة في نماذج الإضافة والتعديل
   - تم التأكد من أن الوظيفة تعمل بشكل صحيح في `places.php` (الأسطر 300-320 و 380-400)

### التغييرات السابقة

1. تحسين ربط الدول والمدن والإحداثيات:
   - إضافة نقطة نهاية API جديدة للحصول على المدن والإحداثيات حسب الدولة
   - تحديث تلقائي للمدينة والإحداثيات عند اختيار الدولة
   - تحديث الخريطة تلقائيًا عند تغيير الدولة

2. إعادة هيكلة نظام تسجيل الدخول:
   - تحسين التحقق من كلمة المرور
   - إضافة تسجيل الأخطاء
   - تحسين رسائل الخطأ

3. تحسين واجهة المستخدم:
   - إضافة شريط تنقل موحد
   - تحسين تصميم الجداول
   - إضافة تصفية للمواقع

4. تحسين الخريطة:
   - إضافة تجميع المواقع
   - تحسين الفلاتر
   - إضافة وسيلة إيضاح

5. إصلاح الأخطاء:
   - مشكلة في إضافة الدول
   - مشكلة في API المستخدمين
   - تحسين التحقق من الصحة

## التحسينات المستقبلية

1. إضافة نظام تقارير وإحصائيات
2. إضافة دعم للصور والملفات
3. تحسين أداء الخريطة مع البيانات الكبيرة
4. إضافة نظام تنبيهات
5. إضافة نظام نسخ احتياطي

## المساهمة

نرحب بمساهماتكم! يرجى اتباع الخطوات التالية:
1. قم بعمل fork للمشروع
2. قم بإنشاء فرع جديد (`git checkout -b feature/amazing-feature`)
3. قم بعمل commit للتغييرات (`git commit -m 'إضافة ميزة رائعة'`)
4. قم بدفع الفرع (`git push origin feature/amazing-feature`)
5. قم بفتح طلب دمج

## الترخيص

هذا المشروع مرخص تحت رخصة MIT. راجع ملف `LICENSE` للمزيد من المعلومات.