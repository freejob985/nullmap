# توثيق وظيفة استيراد الأماكن من ملف Excel

## نظرة عامة
تتيح هذه الوظيفة للمستخدمين استيراد بيانات الأماكن من ملفات Excel بتنسيق .xlsx أو .xls، مما يسهل إدخال كميات كبيرة من البيانات دفعة واحدة بدلاً من إدخالها يدوياً. تم تحسين هذه الوظيفة بإضافة إمكانية تنزيل نموذج Excel فارغ يحتوي على الأعمدة المطلوبة وصف مثال توضيحي، مما يسهل على المستخدمين فهم تنسيق البيانات المطلوب ويقلل من الأخطاء عند الاستيراد.

## الملفات المعدلة
1. `places.php` - تم إضافة زر لتنزيل نموذج Excel فارغ في نافذة الاستيراد
2. `api/template.php` - تم إنشاء ملف جديد لتوفير نموذج Excel فارغ للاستيراد

## الملفات ذات الصلة
1. `api/import.php` - يحتوي على دالة `importPlaces()` التي تعالج عملية استيراد الأماكن
2. `includes/functions/places.php` - يحتوي على دوال التعامل مع الأماكن
3. `schema.sql` - يحتوي على هيكل جدول الأماكن في قاعدة البيانات

## المتطلبات
- مكتبة PhpSpreadsheet مثبتة عبر Composer (للتعامل مع ملفات Excel)
- صلاحية `import_places` للمستخدم أو أن يكون المستخدم مدير النظام
- قاعدة بيانات MySQL تحتوي على جدول الأماكن وجدول الدول

## كيفية الاستخدام

### للمستخدمين

#### تنزيل النموذج
1. انتقل إلى صفحة الأماكن (places.php)
2. انقر على زر "استيراد من Excel"
3. في النافذة المنبثقة، انقر على زر "تنزيل نموذج فارغ" للحصول على ملف Excel بالتنسيق المطلوب
4. سيتم تنزيل ملف Excel يحتوي على الأعمدة المطلوبة وصف مثال توضيحي

#### تعبئة النموذج
5. قم بتعبئة النموذج بالبيانات المطلوبة:
   - **الاسم**: اسم المكان (مطلوب)
   - **الدولة**: اسم الدولة كما هو مسجل في النظام (مطلوب)
   - **المدينة**: اسم المدينة (مطلوب)
   - **النوع**: يجب أن يكون "خاص" أو "حكومي" (مطلوب)
   - **الإجمالي**: قيمة رقمية (اختياري، القيمة الافتراضية 0)
   - **خط العرض**: قيمة رقمية (اختياري)
   - **خط الطول**: قيمة رقمية (اختياري)
6. احفظ الملف بتنسيق .xlsx أو .xls

#### رفع الملف
7. في نافذة استيراد الأماكن، انقر على زر "اختر ملف" واختر ملف Excel المعبأ
8. انقر على زر "رفع الملف" لبدء عملية الاستيراد
9. ستظهر رسالة نجاح أو فشل بناءً على نتيجة العملية
10. في حالة النجاح، سيتم تحديث جدول الأماكن تلقائياً لعرض البيانات الجديدة

### ملاحظات هامة
- يجب أن تكون أسماء الدول مطابقة تماماً للأسماء المسجلة في النظام
- قيم النوع يجب أن تكون "خاص" أو "حكومي" فقط
- سيتم التحقق من صحة البيانات قبل إدخالها في قاعدة البيانات
- في حالة وجود أخطاء، سيتم عرض رسالة توضح الأخطاء المحددة
- يتم تنفيذ عملية الاستيراد ضمن معاملة واحدة (transaction)، مما يعني أنه في حالة وجود أي خطأ، لن يتم إدخال أي من البيانات
- يمكن استيراد عدد كبير من السجلات دفعة واحدة، لكن يجب مراعاة حدود الذاكرة وحجم الملف المسموح برفعه

## تدفق البيانات

### تنزيل النموذج الفارغ
1. المستخدم ينقر على زر "تنزيل نموذج فارغ"
2. يتم إرسال طلب إلى `api/template.php?type=places`
3. يتحقق الخادم من صلاحيات المستخدم
4. يتم استرجاع قائمة الدول من قاعدة البيانات
5. يتم إنشاء ملف Excel يحتوي على الأعمدة المطلوبة وصف مثال توضيحي
6. يتم إرسال الملف للمتصفح للتنزيل

### استيراد البيانات
1. المستخدم يرفع ملف Excel المعبأ
2. يتم إرسال طلب AJAX إلى `api/import.php?type=places`
3. يتحقق الخادم من صلاحيات المستخدم وصحة الملف المرفوع
4. يتم قراءة الملف وتخطيط الأعمدة العربية إلى الحقول الإنجليزية
5. يتم التحقق من صحة البيانات ومطابقة أسماء الدول بمعرفاتها
6. يتم إدخال البيانات الصحيحة في قاعدة البيانات ضمن معاملة واحدة
7. يتم إرسال استجابة JSON تحتوي على حالة العملية وعدد السجلات المستوردة
8. يتم عرض رسالة نجاح أو فشل للمستخدم
9. في حالة النجاح، يتم تحديث جدول الأماكن تلقائياً

## الدوال المستخدمة

### `importPlaces()` في `api/import.php`
- **الوصف**: تستورد بيانات الأماكن من ملف Excel
- **المدخلات**: ملف Excel مرفوع عبر نموذج HTML (`$_FILES['file']`)
- **المخرجات**: استجابة JSON تحتوي على حالة النجاح أو الفشل وعدد السجلات المستوردة
- **العمليات الرئيسية**:
  1. التحقق من صلاحيات المستخدم (`import_places` أو مدير النظام)
  2. التحقق من صحة الملف المرفوع (وجود الملف، امتداد صحيح)
  3. قراءة بيانات الملف باستخدام PhpSpreadsheet
  4. تحويل أسماء الأعمدة العربية إلى أسماء الحقول الإنجليزية
  5. التحقق من وجود الأعمدة المطلوبة (الاسم، الدولة، المدينة، النوع)
  6. بدء معاملة قاعدة البيانات (transaction)
  7. استرجاع قائمة الدول للمطابقة
  8. معالجة كل صف من البيانات:
     - التحقق من صحة البيانات
     - ربط أسماء الدول بمعرفاتها في قاعدة البيانات
     - تحويل قيم النوع (خاص/حكومي) إلى القيم المخزنة في قاعدة البيانات (private/government)
     - إدخال البيانات الصحيحة في جدول الأماكن
  9. تأكيد المعاملة أو التراجع عنها في حالة وجود أخطاء
  10. إرسال استجابة JSON تحتوي على حالة العملية وعدد السجلات المستوردة

### `providePlacesTemplate()` في `api/template.php`
- **الوصف**: توفر نموذج Excel فارغ للاستيراد
- **المدخلات**: لا يوجد
- **المخرجات**: ملف Excel بتنسيق .xls يحتوي على أعمدة فارغة بالعناوين المطلوبة
- **العمليات الرئيسية**:
  1. التحقق من صلاحيات المستخدم (`import_places` أو مدير النظام)
  2. استرجاع قائمة الدول من قاعدة البيانات
  3. تحديد أعمدة النموذج بالعربية (الاسم، الدولة، المدينة، النوع، الإجمالي، خط العرض، خط الطول)
  4. إنشاء ملف Excel جديد
  5. إضافة صف العناوين
  6. إضافة صف مثال توضيحي
  7. إضافة صف فارغ للمستخدم لتعبئته
  8. ضبط رؤوس HTTP للتنزيل
  9. إرسال الملف للمتصفح

### `handleImportForm()` في `places.php` (JavaScript)
- **الوصف**: يعالج نموذج استيراد الأماكن من Excel
- **المدخلات**: نموذج HTML يحتوي على ملف Excel
- **المخرجات**: عرض رسالة نجاح أو فشل للمستخدم
- **العمليات الرئيسية**:
  1. منع السلوك الافتراضي للنموذج
  2. إنشاء كائن FormData لإرسال الملف
  3. إرسال طلب AJAX إلى `api/import.php?type=places`
  4. عرض رسالة تحميل أثناء المعالجة
  5. عرض رسالة نجاح أو فشل بناءً على استجابة الخادم
  6. تحديث جدول الأماكن في حالة النجاح

## نقاط قابلة للتحسين مستقبلاً

1. **تحسين التحقق من صحة البيانات**:
   - إضافة المزيد من التحققات لضمان صحة البيانات المستوردة
   - إضافة دعم للتحقق من تكرار الأماكن قبل الإدخال
   - تحسين رسائل الخطأ لتكون أكثر تفصيلاً وتحديداً

2. **دعم تنسيقات ملفات إضافية**:
   - إضافة دعم لتنسيقات ملفات أخرى مثل CSV
   - إضافة دعم لاستيراد البيانات من مصادر أخرى مثل Google Sheets

3. **تحسين واجهة المستخدم**:
   - إضافة شريط تقدم لعملية الاستيراد
   - إضافة إمكانية معاينة البيانات قبل الاستيراد
   - إضافة إمكانية تحرير البيانات قبل الاستيراد

4. **تحسين إدارة البيانات**:
   - إضافة دعم لتحديث السجلات الموجودة بدلاً من إضافة سجلات جديدة فقط
   - إضافة خيار لتحديد كيفية التعامل مع السجلات المكررة (تجاهل، تحديث، إضافة)
   - إضافة دعم لاستيراد الصور أو المرفقات المتعلقة بالأماكن

5. **تحسين الأداء**:
   - تحسين أداء معالجة الملفات الكبيرة باستخدام تقنيات مثل المعالجة الدفعية
   - تحسين استخدام الذاكرة عند معالجة الملفات الكبيرة
   - إضافة دعم للاستيراد الجزئي في حالة وجود أخطاء في بعض السجلات

## مخطط انسيابي لعملية الاستيراد

يمكن الاطلاع على المخطط الانسيابي التفصيلي لعملية استيراد الأماكن من Excel في ملف `import_places_flowchart.md`.

### المخطط المبسط

```
[بدء] → [النقر على زر استيراد من Excel] → [فتح نافذة الاستيراد]
   ↓
[تنزيل نموذج فارغ (اختياري)] → [تعبئة النموذج] → [رفع الملف]
   ↓
[التحقق من صلاحيات المستخدم] → [قراءة الملف] → [استخراج البيانات]
   ↓
[التحقق من صحة البيانات] → [إدخال البيانات في قاعدة البيانات] → [عرض نتيجة الاستيراد]
   ↓
[تحديث جدول الأماكن] → [نهاية]
```

## الخاتمة

تم تحسين وظيفة استيراد الأماكن من Excel بإضافة إمكانية تنزيل نموذج فارغ للمستخدمين. هذا التحسين يسهل على المستخدمين فهم تنسيق البيانات المطلوب ويقلل من الأخطاء عند الاستيراد. تم توثيق جميع التغييرات والتحسينات بشكل شامل لتسهيل الفهم والتطوير المستقبلي.