# مخطط انسيابي لنظام إدارة المواقع الجغرافية

## مخطط انسيابي لنظام الصلاحيات وتصدير البيانات

```mermaid
flowchart TD
    A[المستخدم] --> B[تسجيل الدخول]
    B --> C{التحقق من البيانات}
    C -->|صحيحة| D[تحميل صلاحيات المستخدم]
    C -->|غير صحيحة| E[عرض رسالة خطأ]
    D --> F[تخزين الصلاحيات في الجلسة]
    
    G[طلب الوصول إلى صفحة] --> H{التحقق من الصلاحيات}
    H -->|لديه صلاحية| I[عرض الصفحة]
    H -->|ليس لديه صلاحية| J[عرض رسالة خطأ 403]
    
    K[طلب تصدير البيانات] --> L{التحقق من صلاحية التصدير}
    L -->|لديه صلاحية| M[استعلام قاعدة البيانات]
    L -->|ليس لديه صلاحية| N[عرض رسالة خطأ 403]
    M --> O[ترجمة أسماء الأعمدة إلى العربية]
    O --> P[إنشاء جدول HTML]
    P --> Q[تنزيل ملف Excel]
    
    R[إدارة صلاحيات المستخدمين] --> S{التحقق من صلاحية الإدارة}
    S -->|لديه صلاحية| T[عرض قائمة المستخدمين]
    S -->|ليس لديه صلاحية| U[عرض رسالة خطأ 403]
    T --> V[تحرير صلاحيات مستخدم]
    V --> W[حفظ التغييرات]
    W --> X[تحديث قاعدة البيانات]
    X --> Y[عرض رسالة نجاح]
```

## مخطط انسيابي لتصفية الأماكن في صفحة الخريطة

```mermaid
flowchart TD
    A[بدء تحميل الصفحة] --> B[تهيئة الخريطة]
    B --> C[تحميل الدول]
    C --> D[تحميل الأماكن الأولية]
    D --> E[تخزين الأماكن في مصفوفة places]
    
    F[تغيير الدولة] --> G[تفريغ قائمة المدن]
    F --> H[تفريغ قائمة الأماكن]
    F --> I[تحميل المدن للدولة المختارة]
    I --> J[تحميل الأماكن المفلترة]
    J --> K[تحميل خيارات الأماكن]
    
    L[تغيير المدينة] --> M[تفريغ قائمة الأماكن]
    L --> N[تحميل الأماكن المفلترة]
    N --> O[تحميل خيارات الأماكن]
    
    P[تغيير النوع] --> Q[تحميل الأماكن المفلترة]
    
    R[تغيير المكان] --> S[تحميل الأماكن المفلترة]
    
    subgraph "دالة loadPlaces"
    T[جمع معايير التصفية] --> U[إرسال طلب AJAX]
    U --> V[استلام البيانات]
    V --> W[تخزين الأماكن في مصفوفة places]
    W --> X[إنشاء العلامات على الخريطة]
    W --> Y[تحميل خيارات الأماكن إذا تم تحديد دولة أو مدينة]
    end
    
    subgraph "دالة loadPlaceOptions"
    Z[تفريغ قائمة الأماكن] --> AA[تصفية الأماكن حسب الدولة والمدينة]
    AA --> AB[استخراج الأماكن الفريدة]
    AB --> AC[ترتيب الأماكن أبجدياً]
    AC --> AD[إضافة الأماكن إلى القائمة المنسدلة]
    end
```

## مخطط انسيابي لعملية تصدير البيانات إلى Excel

```mermaid
flowchart TD
    A[النقر على زر تصدير Excel] --> B{التحقق من صلاحية export_places}
    B -->|لديه صلاحية| C[إرسال طلب GET إلى api/export.php]
    B -->|ليس لديه صلاحية| D[إخفاء زر التصدير]
    
    C --> E[التحقق من تسجيل الدخول]
    E -->|غير مسجل| F[رد بخطأ 401]
    E -->|مسجل| G{التحقق من صلاحية export_places}
    
    G -->|ليس لديه صلاحية| H[رد بخطأ 403]
    G -->|لديه صلاحية| I[استعلام قاعدة البيانات]
    
    I --> J[جلب بيانات الأماكن والدول]
    J --> K[تعيين أسماء الأعمدة بالعربية]
    K --> L[ترجمة قيم نوع المكان إلى العربية]
    L --> M[إنشاء جدول HTML]
    M --> N[إضافة BOM للدعم العربي]
    N --> O[تعيين نوع المحتوى application/vnd.ms-excel]
    O --> P[تعيين اسم الملف places.xls]
    P --> Q[تنزيل الملف للمستخدم]
```

## مخطط انسيابي لنظام الصلاحيات

```mermaid
flowchart TD
    A[تسجيل الدخول] --> B[استدعاء Auth::login]
    B --> C[التحقق من بيانات المستخدم]
    C -->|صحيحة| D[تحميل صلاحيات المستخدم]
    C -->|غير صحيحة| E[رد بخطأ]
    
    D --> F[استدعاء loadUserPermissions]
    F --> G[استعلام جدول user_permissions]
    G --> H[تخزين الصلاحيات في خاصية userPermissions]
    
    I[طلب الوصول إلى صفحة/API] --> J[استدعاء requirePermission]
    J --> K{التحقق من وجود الصلاحية}
    K -->|لديه الصلاحية| L[السماح بالوصول]
    K -->|ليس لديه الصلاحية| M{التحقق من دور المشرف}
    M -->|مشرف| L
    M -->|ليس مشرفًا| N[رد بخطأ 403]
    
    O[إدارة صلاحيات المستخدمين] --> P[عرض صفحة user_permissions.php]
    P --> Q{التحقق من صلاحية manage_permissions}
    Q -->|لديه الصلاحية| R[عرض قائمة المستخدمين]
    Q -->|ليس لديه الصلاحية| S{التحقق من دور المشرف}
    S -->|مشرف| R
    S -->|ليس مشرفًا| T[رد بخطأ 403]
    
    R --> U[النقر على تحرير صلاحيات]
    U --> V[فتح نافذة منبثقة]
    V --> W[استدعاء getUserPermissions]
    W --> X[عرض الصلاحيات الحالية]
    X --> Y[تحديث الصلاحيات]
    Y --> Z[استدعاء assignPermissionsToUser]
    Z --> AA[تحديث قاعدة البيانات]
    AA --> AB[عرض رسالة نجاح]
```

## شرح تدفق البيانات

1. **بدء تحميل الصفحة**:
   - تهيئة الخريطة باستخدام Leaflet
   - تحميل قائمة الدول من API
   - تحميل الأماكن الأولية (بدون تصفية)
   - تخزين الأماكن في مصفوفة `places` للاستخدام اللاحق

2. **تغيير الدولة**:
   - تفريغ قائمة المدن وقائمة الأماكن
   - تحميل المدن للدولة المختارة
   - تحميل الأماكن المفلترة حسب الدولة
   - تحميل خيارات الأماكن المتاحة للدولة المختارة

3. **تغيير المدينة**:
   - تفريغ قائمة الأماكن
   - تحميل الأماكن المفلترة حسب الدولة والمدينة
   - تحميل خيارات الأماكن المتاحة للمدينة المختارة

4. **تغيير النوع أو المكان**:
   - تحميل الأماكن المفلترة حسب المعايير المحددة

5. **دالة loadPlaces**:
   - جمع معايير التصفية (الدولة، المدينة، النوع، المكان)
   - إرسال طلب AJAX إلى API لجلب الأماكن المفلترة
   - استلام البيانات وتخزينها في مصفوفة `places`
   - إنشاء العلامات على الخريطة
   - استدعاء دالة `loadPlaceOptions` إذا تم تحديد دولة أو مدينة

6. **دالة loadPlaceOptions**:
   - تفريغ قائمة الأماكن وإضافة خيار "الكل"
   - تصفية الأماكن حسب الدولة والمدينة المحددة
   - استخراج الأماكن الفريدة (الاسم والمعرف)
   - ترتيب الأماكن أبجدياً
   - إضافة الأماكن إلى القائمة المنسدلة