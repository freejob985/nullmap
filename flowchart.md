# مخطط انسيابي لتصفية الأماكن في صفحة الخريطة

```mermaid
flowchart TD
    A[بدء تحميل الصفحة] --> B[تهيئة الخريطة]
    B --> C[تحميل الدول]
    C --> D[تحميل الأماكن الأولية]
    D --> E[تخزين الأماكن في مصفوفة places]
    
    F[تغيير الدولة] --> G[تفريغ قائمة المدن]
    F --> H[تفريغ قائمة الأماكن]
    F --> I[تحميل المدن للدولة المختارة]
    I --> J[تحميل الأماكن المفلترة]
    J --> K[تحميل خيارات الأماكن]
    
    L[تغيير المدينة] --> M[تفريغ قائمة الأماكن]
    L --> N[تحميل الأماكن المفلترة]
    N --> O[تحميل خيارات الأماكن]
    
    P[تغيير النوع] --> Q[تحميل الأماكن المفلترة]
    
    R[تغيير المكان] --> S[تحميل الأماكن المفلترة]
    
    subgraph "دالة loadPlaces"
    T[جمع معايير التصفية] --> U[إرسال طلب AJAX]
    U --> V[استلام البيانات]
    V --> W[تخزين الأماكن في مصفوفة places]
    W --> X[إنشاء العلامات على الخريطة]
    W --> Y[تحميل خيارات الأماكن إذا تم تحديد دولة أو مدينة]
    end
    
    subgraph "دالة loadPlaceOptions"
    Z[تفريغ قائمة الأماكن] --> AA[تصفية الأماكن حسب الدولة والمدينة]
    AA --> AB[استخراج الأماكن الفريدة]
    AB --> AC[ترتيب الأماكن أبجدياً]
    AC --> AD[إضافة الأماكن إلى القائمة المنسدلة]
    end
```

## شرح تدفق البيانات

1. **بدء تحميل الصفحة**:
   - تهيئة الخريطة باستخدام Leaflet
   - تحميل قائمة الدول من API
   - تحميل الأماكن الأولية (بدون تصفية)
   - تخزين الأماكن في مصفوفة `places` للاستخدام اللاحق

2. **تغيير الدولة**:
   - تفريغ قائمة المدن وقائمة الأماكن
   - تحميل المدن للدولة المختارة
   - تحميل الأماكن المفلترة حسب الدولة
   - تحميل خيارات الأماكن المتاحة للدولة المختارة

3. **تغيير المدينة**:
   - تفريغ قائمة الأماكن
   - تحميل الأماكن المفلترة حسب الدولة والمدينة
   - تحميل خيارات الأماكن المتاحة للمدينة المختارة

4. **تغيير النوع أو المكان**:
   - تحميل الأماكن المفلترة حسب المعايير المحددة

5. **دالة loadPlaces**:
   - جمع معايير التصفية (الدولة، المدينة، النوع، المكان)
   - إرسال طلب AJAX إلى API لجلب الأماكن المفلترة
   - استلام البيانات وتخزينها في مصفوفة `places`
   - إنشاء العلامات على الخريطة
   - استدعاء دالة `loadPlaceOptions` إذا تم تحديد دولة أو مدينة

6. **دالة loadPlaceOptions**:
   - تفريغ قائمة الأماكن وإضافة خيار "الكل"
   - تصفية الأماكن حسب الدولة والمدينة المحددة
   - استخراج الأماكن الفريدة (الاسم والمعرف)
   - ترتيب الأماكن أبجدياً
   - إضافة الأماكن إلى القائمة المنسدلة