# مخطط انسيابي لصفحة الخريطة (map.php)

## تدفق البيانات والعمليات

```
+---------------------+     +---------------------+     +---------------------+
|                     |     |                     |     |                     |
|  تحميل الصفحة       |---->|  تهيئة الخريطة      |---->|  تحميل الأماكن      |
|                     |     |                     |     |                     |
+---------------------+     +---------------------+     +----------+----------+
                                                                  |
                                                                  v
+---------------------+     +---------------------+     +---------------------+
|                     |     |                     |     |                     |
|  تحميل المدن        |<----|  تطبيق التصفية     |<----|  معالجة البيانات   |
|  (حسب الدولة)       |     |                     |     |                     |
+---------------------+     +---------------------+     +---------------------+
        |                             ^                           |
        |                             |                           v
        |                    +--------+--------+        +---------------------+
        |                    |                 |        |                     |
        +-------------------->  تغيير الفلاتر  |<-------+  إنشاء العلامات    |
                             |                 |        |  المخصصة          |
                             +-----------------+        +---------------------+
```

## وصف المكونات الرئيسية

### 1. تحميل الصفحة
- تحميل مكتبات JavaScript اللازمة (Leaflet, MarkerCluster)
- تحميل ملفات CSS
- تهيئة المتغيرات العامة

### 2. تهيئة الخريطة
- إنشاء كائن الخريطة
- تعيين مركز الخريطة ومستوى التكبير
- إضافة طبقة الخريطة الأساسية
- تهيئة مجموعة العلامات

### 3. تحميل الأماكن
- استدعاء API لجلب بيانات الأماكن (`api/places.php`)
- تخزين البيانات للاستخدام في التصفية

### 4. معالجة البيانات
- تطبيق التصفية حسب الدولة والمدينة والنوع
- تحضير البيانات لعرضها على الخريطة

### 5. إنشاء العلامات المخصصة
- إنشاء أيقونات مخصصة حسب نوع المكان
- تعيين الألوان والأيقونات المناسبة
- إضافة النوافذ المنبثقة للعلامات

### 6. تطبيق التصفية
- تصفية الأماكن حسب الدولة المختارة
- تصفية الأماكن حسب المدينة المختارة
- تصفية الأماكن حسب النوع المختار

### 7. تحميل المدن
- تحميل المدن المتاحة بناءً على الدولة المختارة
- تحديث قائمة المدن في فلتر المدينة

### 8. تغيير الفلاتر
- معالجة أحداث تغيير فلتر الدولة
- معالجة أحداث تغيير فلتر المدينة
- معالجة أحداث تغيير فلتر النوع
- إعادة تحميل الأماكن وتحديث الخريطة

## تفاصيل الدوال الرئيسية

### `loadPlaces()`
- **الوظيفة**: تحميل الأماكن وعرضها على الخريطة
- **المدخلات**: لا شيء (تستخدم قيم الفلاتر من واجهة المستخدم)
- **المخرجات**: تحديث الخريطة بالعلامات المصفاة
- **العمليات**:
  1. الحصول على قيم الفلاتر (الدولة، المدينة، النوع)
  2. تفريغ العلامات الموجودة
  3. جلب الأماكن من API
  4. تطبيق التصفية على البيانات
  5. إنشاء العلامات وإضافتها إلى الخريطة
  6. ضبط حدود الخريطة
  7. تحميل المدن إذا تم اختيار دولة

### `loadCities(countryId)`
- **الوظيفة**: تحميل المدن المتاحة بناءً على الدولة المختارة
- **المدخلات**: معرف الدولة المختارة
- **المخرجات**: تحديث قائمة المدن في فلتر المدينة
- **العمليات**:
  1. تفريغ قائمة المدن
  2. إضافة خيار "الكل"
  3. التحقق من وجود معرف دولة
  4. استخراج المدن الفريدة من البيانات
  5. ترتيب المدن أبجدياً
  6. إضافة المدن إلى قائمة الفلتر

### `createCustomIcon(type)`
- **الوظيفة**: إنشاء أيقونة مخصصة للعلامة على الخريطة
- **المدخلات**: نوع المكان (خاص أو حكومة)
- **المخرجات**: كائن أيقونة Leaflet مخصص
- **العمليات**:
  1. تحديد ما إذا كان المكان خاصاً أو حكومياً
  2. تعيين فئة الأيقونة المناسبة
  3. تعيين اسم الأيقونة المناسب
  4. إنشاء كائن أيقونة Leaflet مخصص
  5. تعيين HTML للأيقونة
  6. تعيين حجم الأيقونة ونقطة الارتساء