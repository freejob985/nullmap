# تحديث نظام إدارة الأماكن - NullMap

## نظرة عامة

تم إجراء تحديثات على نظام إدارة الأماكن لمعالجة المشكلات التالية:

1. **إصلاح مشكلة تسجيل الخروج**: تم إصلاح مشكلة عدم تنفيذ عملية تسجيل الخروج بشكل صحيح عند النقر على زر "تسجيل الخروج".
2. **تحسين وظيفة استيراد الأماكن من Excel**: تم إضافة إمكانية تنزيل نموذج Excel فارغ للمستخدمين لتسهيل عملية استيراد الأماكن.

## قائمة الملفات المعدلة

1. **login.php**: إضافة معالجة لطلب تسجيل الخروج وإعادة التوجيه.
2. **places.php**: إضافة زر لتنزيل نموذج Excel فارغ في نافذة استيراد الأماكن.
3. **api/template.php** (ملف جديد): إنشاء ملف API جديد لتوفير نموذج Excel فارغ للأماكن.

## الملفات الإضافية للتوثيق

1. **error_log_update.txt**: توثيق الأخطاء المكتشفة وطرق إصلاحها.
2. **import_places_documentation.md**: توثيق شامل لوظيفة استيراد الأماكن من Excel.
3. **import_places_flowchart.md**: مخطط انسيابي لعملية استيراد الأماكن من Excel.
4. **README_update.md**: هذا الملف، يحتوي على ملخص للتحديثات والتغييرات.

## سجل التعديلات

### 1. إصلاح مشكلة تسجيل الخروج

**الملف**: `login.php`
**الأسطر**: تم إضافة كود جديد في بداية الملف (قبل معالجة نموذج تسجيل الدخول)

**التغييرات**:
```php
// Check if logout request
if (isset($_GET['logout'])) {
    $auth->logout();
    header('Location: login.php?logout_success=1');
    exit;
}
```

**التغيير في عرض رسالة تسجيل الخروج**:
```php
// تم تغيير المعلمة من ?logout إلى ?logout_success=1
if (isset($_GET['logout_success'])) {
    echo '<script>toastr.success("تم تسجيل الخروج بنجاح");</script>';
}
```

### 2. تحسين وظيفة استيراد الأماكن من Excel

**الملف**: `places.php`
**الأسطر**: تم إضافة زر في نافذة استيراد الأماكن (داخل modal-body)

**التغييرات**:
```html
<div class="text-center">
    <a href="api/template.php?type=places" class="btn btn-sm btn-outline-info mt-2">
        <i class="mdi mdi-file-download me-1"></i>
        تنزيل نموذج فارغ
    </a>
</div>
```

**الملف**: `api/template.php` (ملف جديد)
**الوصف**: إنشاء ملف API جديد لتوفير نموذج Excel فارغ للأماكن

## تعليمات التثبيت والاستخدام

### متطلبات النظام

- PHP 7.4 أو أحدث
- مكتبة PhpSpreadsheet (للتعامل مع ملفات Excel)
- قاعدة بيانات MySQL

### تثبيت التحديثات

1. قم بنسخ الملفات المعدلة إلى المجلدات المناسبة في المشروع.
2. تأكد من وجود مكتبة PhpSpreadsheet المثبتة (يمكن تثبيتها عبر Composer).

### استخدام وظيفة تسجيل الخروج

1. انقر على زر "تسجيل الخروج" في شريط التنقل العلوي.
2. سيتم تنفيذ عملية تسجيل الخروج وإعادة توجيهك إلى صفحة تسجيل الدخول مع عرض رسالة نجاح.

### استخدام وظيفة استيراد الأماكن من Excel

1. انتقل إلى صفحة "الأماكن".
2. انقر على زر "استيراد من Excel".
3. في النافذة المنبثقة، انقر على زر "تنزيل نموذج فارغ" للحصول على نموذج Excel.
4. قم بتعبئة النموذج بالبيانات المطلوبة (الاسم، الدولة، المدينة، النوع، الإجمالي، خط العرض، خط الطول).
5. ارفع الملف المعبأ باستخدام زر "اختر ملف".
6. انقر على زر "رفع الملف" لبدء عملية الاستيراد.
7. ستظهر رسالة نجاح أو فشل بناءً على نتيجة العملية.

## تدفق البيانات

### عملية تسجيل الخروج

1. المستخدم ينقر على زر "تسجيل الخروج" في شريط التنقل.
2. يتم توجيه المستخدم إلى `login.php?logout=1`.
3. يتحقق الكود من وجود معلمة `logout` في الطلب.
4. يتم استدعاء دالة `logout()` من كائن `Auth` لتدمير الجلسة.
5. يتم إعادة التوجيه إلى `login.php?logout_success=1`.
6. يتم عرض رسالة "تم تسجيل الخروج بنجاح" باستخدام toastr.

### عملية استيراد الأماكن من Excel

1. المستخدم ينقر على زر "استيراد من Excel" في صفحة الأماكن.
2. تظهر نافذة منبثقة تتيح للمستخدم تنزيل نموذج فارغ أو رفع ملف معبأ.
3. المستخدم ينقر على زر "تنزيل نموذج فارغ" للحصول على نموذج Excel.
4. يتم إرسال طلب إلى `api/template.php?type=places`.
5. يتم إنشاء ملف Excel يحتوي على الأعمدة المطلوبة وصف مثال توضيحي.
6. المستخدم يقوم بتعبئة النموذج ورفعه.
7. يتم إرسال طلب AJAX إلى `api/import.php?type=places`.
8. يتم معالجة الملف وإدخال البيانات في قاعدة البيانات.
9. يتم عرض رسالة نجاح أو فشل بناءً على استجابة الخادم.

## نقاط قابلة للتحسين في المستقبل

1. **تحسين التحقق من صحة البيانات**: إضافة المزيد من التحققات لضمان صحة البيانات المستوردة.
2. **دعم تنسيقات ملفات إضافية**: إضافة دعم لتنسيقات ملفات أخرى مثل CSV.
3. **تحسين واجهة المستخدم**: إضافة شريط تقدم لعملية الاستيراد لتحسين تجربة المستخدم.
4. **إضافة وظيفة التصدير الجزئي**: إتاحة إمكانية تصدير مجموعة محددة من الأماكن بدلاً من تصدير جميع الأماكن.
5. **تحسين معالجة الأخطاء**: توفير رسائل خطأ أكثر تفصيلاً وتحديداً للمستخدم.

## الخاتمة

تم إجراء التحديثات المطلوبة لمعالجة مشكلة تسجيل الخروج وتحسين وظيفة استيراد الأماكن من Excel. تم توثيق جميع التغييرات والتحسينات بشكل شامل لتسهيل الفهم والتطوير المستقبلي.