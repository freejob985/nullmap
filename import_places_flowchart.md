# مخطط انسيابي لعملية استيراد الأماكن من ملف Excel

## المخطط الانسيابي الرئيسي

```mermaid
flowchart TD
    A[بدء العملية] --> B[النقر على زر استيراد من Excel]
    B --> C[فتح نافذة الاستيراد]
    C --> D{هل يحتاج المستخدم لنموذج؟}
    D -->|نعم| E[النقر على زر تنزيل نموذج فارغ]
    E --> F[تنزيل ملف Excel نموذجي]
    F --> G[تعبئة النموذج بالبيانات]
    D -->|لا| G
    G --> H[رفع الملف المعبأ]
    H --> I[النقر على زر رفع الملف]
    I --> J[إرسال طلب AJAX إلى api/import.php]
    J --> K[معالجة الملف وإدخال البيانات]
    K --> L{هل العملية ناجحة؟}
    L -->|نعم| M[عرض رسالة نجاح]
    L -->|لا| N[عرض رسالة خطأ]
    M --> O[تحديث جدول الأماكن]
    N --> P[إغلاق النافذة المنبثقة]
    O --> P
    P --> Q[نهاية العملية]
```

## مخطط معالجة الملف في الخادم

```mermaid
flowchart TD
    A[استلام طلب استيراد] --> B{التحقق من صلاحيات المستخدم}
    B -->|ليس لديه صلاحية| C[رد بخطأ 403]
    B -->|لديه صلاحية| D{التحقق من الملف المرفوع}
    D -->|ملف غير صالح| E[رد بخطأ 400]
    D -->|ملف صالح| F[قراءة الملف باستخدام PhpSpreadsheet]
    F --> G[استخراج الصفوف والأعمدة]
    G --> H[تخطيط الأعمدة العربية إلى الإنجليزية]
    H --> I{التحقق من وجود الأعمدة المطلوبة}
    I -->|أعمدة مفقودة| J[رد بخطأ 400]
    I -->|جميع الأعمدة موجودة| K[بدء معاملة قاعدة البيانات]
    K --> L[استرجاع قائمة الدول للمطابقة]
    L --> M[معالجة كل صف من البيانات]
    M --> N{التحقق من صحة البيانات}
    N -->|بيانات غير صالحة| O[تسجيل الخطأ واستمرار]
    N -->|بيانات صالحة| P[إدخال البيانات في جدول الأماكن]
    O --> Q{هل هناك المزيد من الصفوف؟}
    P --> Q
    Q -->|نعم| M
    Q -->|لا| R{هل هناك أخطاء؟}
    R -->|نعم| S[التراجع عن المعاملة]
    R -->|لا| T[تأكيد المعاملة]
    S --> U[رد بخطأ 400 مع تفاصيل الأخطاء]
    T --> V[رد بنجاح مع عدد السجلات المستوردة]
    U --> W[نهاية]
    V --> W
```

## مخطط تنزيل النموذج الفارغ

```mermaid
flowchart TD
    A[طلب تنزيل نموذج] --> B{التحقق من صلاحيات المستخدم}
    B -->|ليس لديه صلاحية| C[رد بخطأ 403]
    B -->|لديه صلاحية| D[استرجاع قائمة الدول من قاعدة البيانات]
    D --> E[تحديد أعمدة النموذج بالعربية]
    E --> F[إنشاء ملف Excel جديد]
    F --> G[إضافة صف العناوين]
    G --> H[إضافة صف مثال توضيحي]
    H --> I[إضافة صف فارغ للتعبئة]
    I --> J[ضبط رؤوس HTTP للتنزيل]
    J --> K[إرسال الملف للمتصفح]
    K --> L[نهاية]
```

## شرح تدفق البيانات

1. **واجهة المستخدم**:
   - يبدأ المستخدم بالنقر على زر "استيراد من Excel" في صفحة الأماكن
   - تظهر نافذة منبثقة تتيح للمستخدم تنزيل نموذج فارغ أو رفع ملف معبأ
   - بعد رفع الملف، يتم إرسال طلب AJAX إلى الخادم
   - يتم عرض رسالة نجاح أو فشل بناءً على استجابة الخادم

2. **معالجة الملف في الخادم**:
   - يتحقق الخادم من صلاحيات المستخدم وصحة الملف المرفوع
   - يتم قراءة الملف وتخطيط الأعمدة العربية إلى الحقول الإنجليزية
   - يتم التحقق من صحة البيانات ومطابقة أسماء الدول بمعرفاتها
   - يتم إدخال البيانات الصحيحة في قاعدة البيانات ضمن معاملة واحدة
   - يتم إرسال استجابة JSON تحتوي على حالة العملية وعدد السجلات المستوردة

3. **تنزيل النموذج الفارغ**:
   - يتحقق الخادم من صلاحيات المستخدم
   - يتم استرجاع قائمة الدول من قاعدة البيانات
   - يتم إنشاء ملف Excel يحتوي على الأعمدة المطلوبة وصف مثال توضيحي
   - يتم إرسال الملف للمتصفح للتنزيل